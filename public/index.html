<!doctype html>
<html>
<head>
	<title>websocket example</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<style>
		.mask{
			height: 200px;
			overflow: hidden;
			border: 1px solid #ccc;
			background-color: white;
		}

		.win > *{
			background-color: #AFE9BB !important;
		}

		.bet > *{
			border-color: #204d74;
			background-color: #AFCEE9;
		}

		html {
		  position: relative;
		  min-height: 100%;
		}

		body {
		  margin-bottom: 60px;
		}

		body > .main {
		  padding: 0 15px;
		}

		.text-muted {
		  margin: 20px 0;
		}

		.footer {
			position: absolute;
			bottom: 0;
			width: 100%;
			height: 60px;
			background-color: #f5f5f5;
		}

		#remainingTime {
			border: none;
		}

	</style>
</head>
<body>
<!-- CONTENT -->

<header>
	<nav class="navbar navbar-default">
		<div class="container-fluid container">
			<div class="navbar-header">
	      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
	        <span class="sr-only">Toggle navigation</span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	      </button>
	      <a class="navbar-brand" href="#">Auction</a>
	    </div>
	    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	      <ul class="nav navbar-right">
	        <li class="dropdown">
	          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Welcome <span class="user">guest</span>! <span class="caret"></span></a>
	          <ul class="dropdown-menu">
	            <li><a href="#" onClick="logout()">Logout</a></li>
	          </ul>
	        </li>
	      </ul>
		</div>
	</nav>
	<div class="container">
		<div class="page-header">
	 	 <h1>Auction list <small>place your bet</small></h1>
	 	</div>
	</div>
</header>

<div class="container main">
	<div id="auctions" class="row">
		<!-- render auctions here -->
	</div>
</div>

<footer class="footer">
  <div class="container">
    <p class="text-muted">Some footer text</p>
  </div>
</footer>

<!-- LOGIN - MODAL -->
	<div id="loginModal" class="modal fade" tabindex="-1" role="dialog">
		<div class="modal-dialog" data-show="true">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Login</h4>
				</div>
				<div class="modal-body">
					<form id="login-form">
						<div class="input-group">
							<input id="username" class="form-control" placeholder="username" autocomplete="off" />
							<span class="input-group-btn">
								<button class="btn btn-default" type="submit">Send</button>
							</span>
						</div>
					</form>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->

<!-- Bet - MODAL -->
<div id="betModal" class="modal fade" tabindex="-1" role="dialog">
	<div class="modal-dialog" data-show="true">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="productHeadline">product</h4>
			</div>
			<div class="modal-body">
				<div class="mask">
					<img id="productImage" class="col-sm-12" src="/img/iPhone6.jpeg" alt="product">
				</div>
				<div style="padding:10px 0;">
					<strong>Remaining Time:</strong> <input id="remainingTime">
				</div>
				<form id="bet-form">
					<div class="input-group">
						<input id="modalId" type="hidden"/>
						<input id="bet" type="number" max="1000000" class="form-control" step="0.01" placeholder="0.10" autocomplete="off" />
						<span class="input-group-btn">
							<button class="btn btn-default" type="submit">Place Bet</button>
						</span>
					</div>
				</form>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- SCRIPTS -->
	<script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
	<script src="socket.io/socket.io.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
	<script>
  	var activeInput
		var user = {
			username: "",
			loginTime: ""
		}
		var products = {}
		var socket = io();
		
		$('#login-form').submit(function(){
			socket.emit('login', $('#username').val());
			user.username = $('#username').val();
			user.loginTime = new Date();
			$('#username').val('');
			return false;
		});

		socket.on('authenticated', function(data){
			if(data.msg === true){
				if(document.cookie === "" || document.cookie === "username=null"){	
					$('#loginModal').modal('hide');
					createCookie("username", user.username, "");
				}
				$.each($('.user'), function(index, value){
					$('.user')[index].innerHTML = user.username;
				});
				products = data.products;
				$.each(data.products, function(index, value){
					renderAuction(value.name, value.id, value.endTime);
					initializeClock(value.id+"timer", value.endTime, index);
					$.each(products[index].bets, function(index, value){
						if(value.user == user.username){
							$(`#${value.id}`).addClass("bet");
							showBet(value.id, value.value)
						}
					})	
				})
				$('#loginModal').modal('hide');
			} else {
				console.log("error")
				$("#username").value = "username has been taken";
				$('#loginModal').modal('show');
			}
		});

		socket.on('end', function(data){
			if(data.user === user.username){
				$(`#${data.product}timer`).val("you won")
				$(`#${data.product}`).addClass("win")
			}
		})

		$('#bet-form').submit(function(){
			if($('#bet').val() > 0){
				$('#betModal').modal('toggle')
				socket.emit('setBet', {id: $('#modalId').val(), value: $('#bet').val(), user: user.username})
				showBet($('#modalId').val(), $('#bet').val())
			}
			return false;
		})

		function logout(){
			socket.emit('logout', user.username)
			createCookie("username", "", -1)
			user = {
				username: "",
				loginTime: ""
			}
			$.each($('.user'), function(index, value){
					$('.user')[index].innerHTML = "Guest";
				});
			$('#loginModal').modal('toggle');
			$('#auctions')[0].innerHTML = "";
		}

		function toggleBet(productName, endTime, betId){
			$('#productHeadline')[0].innerHTML = productName;
			$('#modalId').val(betId);
			$('#productImage')[0].src = "img/"+ productName + ".jpeg";
			activeInput = betId+"timer";
			$('#betModal').modal('toggle');
		}

		function renderAuction(productName, betId, endTime){
			if(getTimeRemaining(endTime).total > 0){
				$('#auctions').append(
					`<div id="${betId}" class="col-sm-6 col-md-4">
				    <div class="thumbnail">
				    	<div class="mask">
				   	   <img class="col-sm-12" src="img/${productName}.jpeg" alt="${productName}">
				   	  </div>
				      <div class="caption clearfix">
					      <div class="your-bet invisible">Hello World</div>
					      <h3>${productName}</h3>
				        <p>Place your bet on the ${productName}</p>
				        <input readonly id="${betId}timer" >
				        <p><a href="#" onClick='toggleBet("${productName}", "${endTime}", "${betId}")' class="btn btn-primary pull-right" role="button">Place new bet</a></p>
				      </div>
				    </div>
				  </div>`
			  );
			} else {
				$('#auctions').append(
					`<div id="${betId}" class="col-sm-6 col-md-4">
				    <div class="thumbnail">
				    	<div class="mask">
				   	   <img class="col-sm-12" src="img/${productName}.jpeg" alt="${productName}">
				   	  </div>
				      <div class="caption clearfix">
					      <div class="your-bet invisible">Hello World</div>
					      <h3>${productName}</h3>
				        <p>you can't bid on ${productName} anymore</p>
				        <input readonly id="${betId}timer" >
				        <p><a href="#" class="btn btn-primary disabled pull-right" role="button">expired</a></p>
				      </div>
				    </div>
				  </div>`
			  );
			}
		}

		function showBet(betId, price){
			$(`#${betId} .your-bet`)[0].innerHTML = 'you bet â‚¬' + rightPadding(price, 2);
			$(`#${betId} .your-bet`).removeClass("invisible");
			$(`#${betId}`).addClass("bet");
		}

		function initializeClock(id, endTime, num){
		  var clock = document.getElementById(id)
		  products[num].timer = setInterval(function(){
		    var t = getTimeRemaining(endTime);
		    var clockValue = "";
		    if(t.days != 0)
		    	clockValue += t.days  + ' days,' + ' '
		    if(t.hours != 0)
					clockValue += t.hours   + 'h '
				if(t.minutes != 0)
					clockValue += t.minutes + 'm '
				if(t.total > 0)
		      clockValue += t.seconds + 's';
		    else
		    	clockValue = "auction has closed"
		    
		    clock.value = clockValue;

		    if(id === activeInput){
		   		$("#remainingTime")[0].value = clockValue;
				}
		    if(t.total <= 0){
		      clearInterval(products[num].timer);
		    }
		  },1000);
		}

		function getTimeRemaining(endTime){
		  var t = Date.parse(endTime) - Date.parse(new Date());
		  var seconds = Math.floor( (t/1000) % 60 );
		  var minutes = Math.floor( (t/1000/60) % 60 );
		  var hours = Math.floor( (t/(1000*60*60)) % 24 );
		  var days = Math.floor( t/(1000*60*60*24) );
		  return {
		    'total': t,
		    'days': days,
		    'hours': hours,
		    'minutes': minutes,
		    'seconds': seconds
		  };
		}

		function createCookie(name,value,days) {
	    if (days) {
        var date = new Date();
        date.setTime(date.getTime()+(days*24*60*60*1000));
        var expires = "; expires="+date.toGMTString();
	    }
	    else var expires = "";
	    document.cookie = name+"="+value+expires+"; path=/";
		}

		function readData(){
			user.username = readCookie("username")
			if(user.username === "" || user.username === null){
				$('#loginModal').modal('toggle')
			} else {
				socket.emit('login', user.username)
			}
		}

		function readCookie(name) {
	    var nameEQ = name + "=";
	    var ca = document.cookie.split(';');
	    for(var i=0;i < ca.length;i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1,c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
	    }
	    return null;
		}

		function rightPadding(price, decimals){
			if(price.toString().indexOf(".")===-1){
				price += "."
				for(let i=0; i < decimals; i+=1){
					price += "0"
				}
				return price
			}
			padds = (decimals + 1) - (price.toString().length - price.toString().indexOf("."))
			for(let i=0; i < padds; i+=1){
				price += 0
			}
			return price;
		}

		function findById(source, id) {
		  for (var i = 0; i < source.length; i++) {
		    if (source[i].id === id) {
		      return i;
		    }
		  }
		  return -1;
		}

		readData()
	</script>
</body>
</html>